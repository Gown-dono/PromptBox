<Window x:Class="PromptBox.Views.PromptTestingDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        Title="Prompt Testing &amp; A/B Comparison"
        Width="1500" Height="950"
        WindowStartupLocation="CenterOwner"
        Style="{StaticResource MaterialDesignWindow}">
    
    <materialDesign:DialogHost Identifier="TestingDialog">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <Grid Grid.Row="0" Margin="16">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="350"/>
                    <ColumnDefinition Width="400"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <!-- Left Panel: Test Management -->
                <Border Grid.Column="0" Margin="0,0,8,0"
                        Background="{DynamicResource MaterialDesignCardBackground}"
                        CornerRadius="8">
                    <Grid Margin="12">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <TextBlock Grid.Row="0" Text="Prompt Tests" 
                                   Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                                   Margin="0,0,0,12"/>
                        
                        <TextBox Grid.Row="1" x:Name="TestSearchBox"
                                 materialDesign:HintAssist.Hint="Search tests..."
                                 Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                 Margin="0,0,0,8"
                                 TextChanged="TestSearchBox_TextChanged"/>
                        
                        <ListBox Grid.Row="2" x:Name="TestsListBox"
                                 SelectionChanged="TestsListBox_SelectionChanged"
                                 VirtualizingPanel.IsVirtualizing="True">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="4">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Grid.Row="0" Text="{Binding Name}" FontWeight="SemiBold"/>
                                        <TextBlock Grid.Row="1" Opacity="0.7" FontSize="11">
                                            <Run Text="{Binding TestCases.Count, Mode=OneWay}"/>
                                            <Run Text=" test cases"/>
                                        </TextBlock>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>

                        <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="0,8,0,0">
                            <Button Content="New" Click="NewTest_Click" Margin="0,0,4,0"
                                    Style="{StaticResource MaterialDesignRaisedButton}"/>
                            <Button Content="Edit" Click="EditTest_Click" Margin="0,0,4,0"
                                    Style="{StaticResource MaterialDesignRaisedButton}"/>
                            <Button Content="Delete" Click="DeleteTest_Click"
                                    Style="{StaticResource MaterialDesignRaisedButton}"/>
                        </StackPanel>
                    </Grid>
                </Border>
                
                <!-- Middle Panel: Test Configuration -->
                <Border Grid.Column="1" Margin="8,0"
                        Background="{DynamicResource MaterialDesignCardBackground}"
                        CornerRadius="8">
                    <TabControl Margin="12" Style="{StaticResource MaterialDesignNavigationRailTabControl}">
                        <!-- Test Cases Tab -->
                        <TabItem Header="Test Cases">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <DataGrid Grid.Row="0" x:Name="TestCasesDataGrid"
                                          AutoGenerateColumns="False"
                                          CanUserAddRows="False"
                                          IsReadOnly="True"
                                          SelectionMode="Single">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="100"/>
                                        <DataGridTextColumn Header="Input" Binding="{Binding Input}" Width="120"/>
                                        <DataGridTextColumn Header="Keywords" Binding="{Binding ExpectedKeywords.Count}" Width="60"/>
                                        <DataGridTextColumn Header="Min Score" Binding="{Binding MinQualityScore}" Width="70"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                                
                                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,8,0,0">
                                    <Button Content="Add" Click="AddTestCase_Click" Margin="0,0,4,0"
                                            Style="{StaticResource MaterialDesignRaisedButton}"/>
                                    <Button Content="Edit" Click="EditTestCase_Click" Margin="0,0,4,0"
                                            Style="{StaticResource MaterialDesignRaisedButton}"/>
                                    <Button Content="Remove" Click="RemoveTestCase_Click"
                                            Style="{StaticResource MaterialDesignRaisedButton}"/>
                                </StackPanel>
                            </Grid>
                        </TabItem>
                        
                        <!-- Evaluation Criteria Tab -->
                        <TabItem Header="Criteria">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <StackPanel Margin="4">
                                    <CheckBox x:Name="CheckKeywordsBox" Content="Check Keywords" IsChecked="True" Margin="0,4"/>
                                    <CheckBox x:Name="CheckPatternsBox" Content="Check Patterns" Margin="0,4"/>
                                    <CheckBox x:Name="CheckQualityScoreBox" Content="Check Quality Score" IsChecked="True" Margin="0,4"/>
                                    
                                    <TextBlock Text="Minimum Quality Score" Margin="0,12,0,4" Opacity="0.7"/>
                                    <Slider x:Name="MinQualitySlider" Minimum="0" Maximum="100" Value="50"
                                            TickFrequency="10" IsSnapToTickEnabled="True"/>
                                    <TextBlock x:Name="MinQualityValue" Text="50" HorizontalAlignment="Center"/>
                                    
                                    <CheckBox x:Name="CheckTokenUsageBox" Content="Check Token Usage" Margin="0,12,0,4"/>
                                    <TextBox x:Name="MaxTokensBox" materialDesign:HintAssist.Hint="Max Tokens"
                                             Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                             Text="2000" Margin="0,4"/>
                                    
                                    <CheckBox x:Name="CheckResponseTimeBox" Content="Check Response Time" Margin="0,12,0,4"/>
                                    <TextBox x:Name="MaxResponseTimeBox" materialDesign:HintAssist.Hint="Max Seconds"
                                             Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                             Text="30" Margin="0,4"/>
                                </StackPanel>
                            </ScrollViewer>
                        </TabItem>
                        
                        <!-- A/B Testing Tab -->
                        <TabItem Header="A/B Test">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="120"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <TextBlock Grid.Row="0" Text="Prompt Variations" FontWeight="SemiBold" Margin="0,0,0,8"/>
                                
                                <ListBox Grid.Row="1" x:Name="VariationsListBox" MinHeight="100">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Name}"/>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                                
                                <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,8">
                                    <Button Content="From Prompt" Click="AddVariationFromPrompt_Click" Margin="0,0,4,0"
                                            Style="{StaticResource MaterialDesignRaisedButton}" Height="28" FontSize="11" Padding="8,0"/>
                                    <Button Content="Add Manual" Click="AddVariation_Click" Margin="0,0,4,0"
                                            Style="{StaticResource MaterialDesignRaisedButton}" Height="28" FontSize="11" Padding="8,0"/>
                                    <Button Content="Remove" Click="RemoveVariation_Click"
                                            Style="{StaticResource MaterialDesignRaisedButton}" Height="28" FontSize="11" Padding="8,0"/>
                                </StackPanel>
                                
                                <TextBox Grid.Row="3" x:Name="ComparisonInputBox"
                                         materialDesign:HintAssist.Hint="Test Input for Comparison"
                                         Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                         AcceptsReturn="True" TextWrapping="Wrap"
                                         VerticalScrollBarVisibility="Auto"/>
                                
                                <Button Grid.Row="4" Content="Run Comparison" Click="RunComparison_Click"
                                        Style="{StaticResource MaterialDesignRaisedButton}"
                                        Margin="0,8,0,0"/>
                            </Grid>
                        </TabItem>
                    </TabControl>
                </Border>

                
                <!-- Right Panel: Results & Visualization -->
                <Border Grid.Column="2" Margin="8,0,0,0"
                        Background="{DynamicResource MaterialDesignCardBackground}"
                        CornerRadius="8">
                    <Grid Margin="12">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Progress Section -->
                        <StackPanel Grid.Row="0" Margin="0,0,0,12">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <ProgressBar x:Name="OverallProgressBar" Height="8" Value="0"/>
                                <TextBlock Grid.Column="1" x:Name="ProgressText" Text="0%" Margin="8,0,0,0"/>
                            </Grid>
                            <TextBlock x:Name="CurrentOperationText" Opacity="0.7" FontSize="11" Margin="0,4,0,0"/>
                        </StackPanel>
                        
                        <!-- Statistics Panel -->
                        <Border Grid.Row="1" Background="{DynamicResource MaterialDesignToolBarBackground}"
                                CornerRadius="4" Padding="12" Margin="0,0,0,12">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                                    <TextBlock Text="Total" Opacity="0.7" FontSize="11"/>
                                    <TextBlock x:Name="TotalCountText" Text="0" FontSize="18" FontWeight="Bold"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                                    <TextBlock Text="Passed" Opacity="0.7" FontSize="11"/>
                                    <TextBlock x:Name="PassedCountText" Text="0" FontSize="18" FontWeight="Bold" Foreground="Green"/>
                                </StackPanel>
                                <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                                    <TextBlock Text="Failed" Opacity="0.7" FontSize="11"/>
                                    <TextBlock x:Name="FailedCountText" Text="0" FontSize="18" FontWeight="Bold" Foreground="Red"/>
                                </StackPanel>
                                <StackPanel Grid.Column="3" HorizontalAlignment="Center">
                                    <TextBlock Text="Pass Rate" Opacity="0.7" FontSize="11"/>
                                    <TextBlock x:Name="PassRateText" Text="0%" FontSize="18" FontWeight="Bold"/>
                                </StackPanel>
                                <StackPanel Grid.Column="4" HorizontalAlignment="Center">
                                    <TextBlock Text="Avg Quality" Opacity="0.7" FontSize="11"/>
                                    <TextBlock x:Name="AvgQualityText" Text="0" FontSize="18" FontWeight="Bold"/>
                                </StackPanel>
                                <StackPanel Grid.Column="5" HorizontalAlignment="Center">
                                    <TextBlock Text="Tokens" Opacity="0.7" FontSize="11"/>
                                    <TextBlock x:Name="TotalTokensText" Text="0" FontSize="18" FontWeight="Bold"/>
                                </StackPanel>
                            </Grid>
                        </Border>
                        
                        <!-- Results Tabs -->
                        <TabControl Grid.Row="2" Style="{StaticResource MaterialDesignNavigationRailTabControl}">
                            <!-- Test Results Tab -->
                            <TabItem Header="Results">
                                <DataGrid x:Name="ResultsDataGrid"
                                          AutoGenerateColumns="False"
                                          CanUserAddRows="False"
                                          IsReadOnly="True"
                                          MouseDoubleClick="ResultsDataGrid_MouseDoubleClick">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Status" Binding="{Binding StatusIcon}" Width="50"/>
                                        <DataGridTextColumn Header="Test Case" Binding="{Binding TestCaseName}" Width="100"/>
                                        <DataGridTextColumn Header="Model" Binding="{Binding ModelName}" Width="100"/>
                                        <DataGridTextColumn Header="Resp Quality" Binding="{Binding QualityScoreFormatted}" Width="75"/>
                                        <DataGridTextColumn Header="Resp Clarity" Binding="{Binding ClarityScoreFormatted}" Width="75"/>
                                        <DataGridTextColumn Header="Resp Specificity" Binding="{Binding SpecificityScoreFormatted}" Width="95"/>
                                        <DataGridTextColumn Header="Effectiveness" Binding="{Binding EffectivenessScoreFormatted}" Width="80"/>
                                        <DataGridTextColumn Header="Tokens" Binding="{Binding TokensUsed}" Width="60"/>
                                        <DataGridTextColumn Header="Duration" Binding="{Binding DurationFormatted}" Width="70"/>
                                        <DataGridTextColumn Header="Output" Binding="{Binding OutputPreview}" Width="*"/>
                                    </DataGrid.Columns>
                                    <DataGrid.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="View Full Output" Click="ViewFullOutput_Click"/>
                                            <MenuItem Header="Copy Output" Click="CopyOutput_Click"/>
                                            <MenuItem Header="View Failure Details" Click="ViewFailureDetails_Click"/>
                                            <Separator/>
                                            <MenuItem Header="Rerun Test" Click="RerunTest_Click"/>
                                        </ContextMenu>
                                    </DataGrid.ContextMenu>
                                </DataGrid>
                            </TabItem>
                            
                            <!-- Comparison Results Tab -->
                            <TabItem Header="Comparison">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    
                                    <DataGrid Grid.Row="0" x:Name="ComparisonDataGrid"
                                              AutoGenerateColumns="False"
                                              CanUserAddRows="False"
                                              IsReadOnly="True">
                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="Rank" Binding="{Binding RankingIcon}" Width="50"/>
                                            <DataGridTextColumn Header="Variation" Binding="{Binding VariationName}" Width="120"/>
                                            <DataGridTextColumn Header="Model" Binding="{Binding ModelName}" Width="100"/>
                                            <DataGridTextColumn Header="Quality" Binding="{Binding QualityScoreFormatted}" Width="70"/>
                                            <DataGridTextColumn Header="Tokens" Binding="{Binding TokensFormatted}" Width="70"/>
                                            <DataGridTextColumn Header="Duration" Binding="{Binding DurationFormatted}" Width="80"/>
                                            <DataGridTextColumn Header="Output Preview" Binding="{Binding OutputPreview}" Width="*"/>
                                        </DataGrid.Columns>
                                        <DataGrid.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="View Full Output" Click="ViewComparisonOutput_Click"/>
                                                <MenuItem Header="Copy Output" Click="CopyComparisonOutput_Click"/>
                                            </ContextMenu>
                                        </DataGrid.ContextMenu>
                                    </DataGrid>
                                    
                                    <StackPanel Grid.Row="1" Margin="0,8,0,0">
                                        <TextBlock x:Name="WinnerAnalysisText" TextWrapping="Wrap" FontStyle="Italic"/>
                                        <Button Content="Export Comparison Report" Click="ExportComparison_Click"
                                                Style="{StaticResource MaterialDesignRaisedButton}"
                                                HorizontalAlignment="Left" Margin="0,8,0,0"/>
                                    </StackPanel>
                                </Grid>
                            </TabItem>
                            
                            <!-- Model Selection Tab -->
                            <TabItem Header="Models">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    
                                    <TextBlock Grid.Row="0" Text="Select models to test against:" Margin="0,0,0,8"/>
                                    
                                    <ListBox Grid.Row="1" x:Name="ModelsListBox" SelectionMode="Multiple">
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <CheckBox IsChecked="{Binding IsSelected}" Margin="4">
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                                        <TextBlock Text=" - " Opacity="0.5"/>
                                                        <TextBlock Text="{Binding Provider}" Opacity="0.7"/>
                                                    </StackPanel>
                                                </CheckBox>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </Grid>
                            </TabItem>
                            
                            <!-- Analytics Tab -->
                            <TabItem Header="Analytics">
                                <ScrollViewer VerticalScrollBarVisibility="Auto">
                                    <StackPanel Margin="8">
                                        <!-- Summary Section -->
                                        <TextBlock Text="ðŸ“Š Test Summary" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,12"/>
                                        <Border Background="{DynamicResource MaterialDesignToolBarBackground}" CornerRadius="4" Padding="12" Margin="0,0,0,16">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock x:Name="AnalyticsSummaryText" TextWrapping="Wrap" FontSize="13"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="1">
                                                    <TextBlock x:Name="AnalyticsPassRateText" TextWrapping="Wrap" FontSize="13"/>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                        
                                        <!-- Quality Scores Section -->
                                        <TextBlock Text="ðŸ“ˆ Quality Score Distribution" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,12"/>
                                        <Border Background="{DynamicResource MaterialDesignToolBarBackground}" CornerRadius="4" Padding="12" Margin="0,0,0,16">
                                            <StackPanel>
                                                <TextBlock x:Name="AnalyticsQualityText" TextWrapping="Wrap" FontSize="13"/>
                                            </StackPanel>
                                        </Border>
                                        
                                        <!-- Per-Model Breakdown -->
                                        <TextBlock Text="ðŸ¤– Results by Model" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,12"/>
                                        <Border Background="{DynamicResource MaterialDesignToolBarBackground}" CornerRadius="4" Padding="12" Margin="0,0,0,16">
                                            <StackPanel x:Name="AnalyticsModelBreakdownPanel"/>
                                        </Border>
                                        
                                        <!-- Per-Test-Case Breakdown -->
                                        <TextBlock Text="ðŸ“ Results by Test Case" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,12"/>
                                        <Border Background="{DynamicResource MaterialDesignToolBarBackground}" CornerRadius="4" Padding="12" Margin="0,0,0,16">
                                            <StackPanel x:Name="AnalyticsTestCaseBreakdownPanel"/>
                                        </Border>
                                        
                                        <!-- Token Usage Section -->
                                        <TextBlock Text="ðŸ”¢ Token Usage" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,12"/>
                                        <Border Background="{DynamicResource MaterialDesignToolBarBackground}" CornerRadius="4" Padding="12">
                                            <StackPanel>
                                                <TextBlock x:Name="AnalyticsTokensText" TextWrapping="Wrap" FontSize="13"/>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                </ScrollViewer>
                            </TabItem>
                        </TabControl>
                    </Grid>
                </Border>
            </Grid>
            
            <!-- Footer -->
            <Border Grid.Row="1" Background="{DynamicResource MaterialDesignToolBarBackground}" Padding="16,12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBlock Grid.Column="0" x:Name="StatusText" Text="Ready" VerticalAlignment="Center"/>
                    
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button x:Name="RunButton" Content="Run Tests" Click="RunTests_Click"
                                Style="{StaticResource MaterialDesignRaisedButton}" Margin="0,0,8,0"/>
                        <Button x:Name="PauseButton" Content="Pause" Click="PauseBatch_Click"
                                Style="{StaticResource MaterialDesignRaisedButton}" Margin="0,0,8,0" IsEnabled="False"/>
                        <Button x:Name="CancelButton" Content="Cancel" Click="CancelBatch_Click"
                                Style="{StaticResource MaterialDesignRaisedButton}" Margin="0,0,8,0" IsEnabled="False"/>
                        <Button x:Name="ExportButton" Content="Export Results" Click="ExportResults_Click"
                                Style="{StaticResource MaterialDesignRaisedButton}" Margin="0,0,8,0" IsEnabled="False"
                                ToolTip="Export results as CSV or JSON with full output data."/>
                        <Button Content="Close" Click="Close_Click"
                                Style="{StaticResource MaterialDesignFlatButton}"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </materialDesign:DialogHost>
</Window>
