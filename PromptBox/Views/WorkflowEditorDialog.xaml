<Window x:Class="PromptBox.Views.WorkflowEditorDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:controls="clr-namespace:PromptBox.Controls"
        Title="Workflow Editor" 
        Height="800" Width="1200"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource MaterialDesignPaper}"
        FontFamily="{materialDesign:MaterialDesignFont}">
    
    <materialDesign:DialogHost Identifier="WorkflowEditorDialog">
        <Grid Margin="16">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <!-- Workflow Info -->
            <StackPanel Grid.Row="0">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBlock Text="WORKFLOW DETAILS" 
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource MaterialDesignBodyLight}"
                               VerticalAlignment="Center"/>
                    
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button Content="Import JSON"
                                Click="ImportJson_Click"
                                Style="{StaticResource MaterialDesignFlatMidBgButton}"
                                Height="28"
                                FontSize="12"
                                Margin="0,0,0,8"
                                ToolTip="Import workflow from JSON file"/>
                    </StackPanel>
                </Grid>
                
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <TextBox x:Name="WorkflowNameBox"
                             Grid.Column="0"
                             materialDesign:HintAssist.Hint="Workflow Name"
                             Margin="0,0,8,0"
                             Foreground="{DynamicResource MaterialDesignBody}"/>
                    <TextBox x:Name="WorkflowCategoryBox"
                             Grid.Column="1"
                             materialDesign:HintAssist.Hint="Category"
                             Margin="8,0,8,0"
                             Foreground="{DynamicResource MaterialDesignBody}"/>
                    <TextBox x:Name="WorkflowDescriptionBox"
                             Grid.Column="2"
                             materialDesign:HintAssist.Hint="Description"
                             Margin="8,0,0,0"
                             Foreground="{DynamicResource MaterialDesignBody}"/>
                </Grid>
            </StackPanel>
            
            <!-- Tab Control for Visual/List Views -->
            <TabControl Grid.Row="1" Margin="0,16,0,0">
                <!-- Visual Designer Tab -->
                <TabItem>
                    <TabItem.Header>
                        <StackPanel Orientation="Horizontal">
                            <materialDesign:PackIcon Kind="GraphOutline" VerticalAlignment="Center"/>
                            <TextBlock Text="Visual Designer" Margin="8,0,0,0"/>
                        </StackPanel>
                    </TabItem.Header>
                    
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="300"/>
                        </Grid.ColumnDefinitions>
                        
                        <!-- Canvas -->
                        <controls:WorkflowCanvas x:Name="WorkflowCanvas"
                                                 Grid.Column="0"
                                                 StepSelected="WorkflowCanvas_StepSelected"
                                                 StepDoubleClicked="WorkflowCanvas_StepDoubleClicked"
                                                 WorkflowModified="WorkflowCanvas_WorkflowModified"/>
                        
                        <!-- Properties Panel -->
                        <Border Grid.Column="1" 
                                BorderBrush="{DynamicResource MaterialDesignDivider}"
                                BorderThickness="1,0,0,0"
                                Padding="12">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <StackPanel x:Name="PropertiesPanel">
                                    <TextBlock Text="STEP PROPERTIES" 
                                               FontWeight="SemiBold"
                                               Foreground="{DynamicResource MaterialDesignBodyLight}"
                                               Margin="0,0,0,12"/>
                                    
                                    <TextBlock x:Name="NoSelectionText"
                                               Text="Select a step to edit its properties"
                                               Foreground="{DynamicResource MaterialDesignBodyLight}"
                                               FontStyle="Italic"/>
                                    
                                    <StackPanel x:Name="StepPropertiesPanel" Visibility="Collapsed">
                                        <!-- Step Name -->
                                        <TextBox x:Name="StepNameBox"
                                                 materialDesign:HintAssist.Hint="Step Name"
                                                 TextChanged="StepProperty_Changed"
                                                 Margin="0,0,0,8"
                                                 Foreground="{DynamicResource MaterialDesignBody}"/>
                                        
                                        <!-- Step Type -->
                                        <ComboBox x:Name="StepTypeCombo"
                                                  materialDesign:HintAssist.Hint="Step Type"
                                                  Foreground="{DynamicResource MaterialDesignBody}"
                                                  SelectionChanged="StepType_Changed"
                                                  Margin="0,0,0,8">
                                            <ComboBoxItem Content="Standard" Tag="Standard"/>
                                            <ComboBoxItem Content="Conditional" Tag="Conditional"/>
                                            <ComboBoxItem Content="Loop" Tag="Loop"/>
                                            <ComboBoxItem Content="Parallel" Tag="Parallel"/>
                                        </ComboBox>
                                        
                                        <!-- Step Description -->
                                        <TextBox x:Name="StepDescriptionBox"
                                                 materialDesign:HintAssist.Hint="Description"
                                                 TextChanged="StepProperty_Changed"
                                                 Margin="0,0,0,8"
                                                 Foreground="{DynamicResource MaterialDesignBody}"/>
                                        
                                        <!-- Output Variable -->
                                        <TextBox x:Name="StepOutputVariableBox"
                                                 materialDesign:HintAssist.Hint="Output Variable Name"
                                                 TextChanged="StepProperty_Changed"
                                                 Margin="0,0,0,8"
                                                 Foreground="{DynamicResource MaterialDesignBody}"/>
                                        
                                        <!-- Prompt Template -->
                                        <TextBlock Text="Prompt Template" 
                                                   FontWeight="SemiBold"
                                                   Foreground="{DynamicResource MaterialDesignBody}"
                                                   Margin="0,8,0,4"/>
                                        <Border BorderBrush="{DynamicResource MaterialDesignDivider}" 
                                                BorderThickness="1" 
                                                CornerRadius="4">
                                            <TextBox x:Name="StepPromptBox"
                                                     AcceptsReturn="True"
                                                     TextWrapping="Wrap"
                                                     MinHeight="120"
                                                     MaxHeight="200"
                                                     VerticalScrollBarVisibility="Auto"
                                                     Padding="8"
                                                     FontFamily="Consolas"
                                                     FontSize="11"
                                                     BorderThickness="0"
                                                     TextChanged="StepProperty_Changed"
                                                     Foreground="{DynamicResource MaterialDesignBody}"
                                                     Background="Transparent"/>
                                        </Border>
                                        
                                        <!-- Conditional Branches Configuration -->
                                        <StackPanel x:Name="ConditionalBranchesPanel" Visibility="Collapsed" Margin="0,12,0,0">
                                            <TextBlock Text="CONDITIONAL BRANCHES" 
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                       Margin="0,0,0,8"/>
                                            
                                            <TextBlock Text="Create and manage branches here. Each branch evaluates a condition and routes to a target step. Use the canvas to visually connect branches to target steps, or set the target step ID directly."
                                                       TextWrapping="Wrap"
                                                       FontSize="11"
                                                       Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                       Margin="0,0,0,8"/>
                                            
                                            <ItemsControl x:Name="BranchesItemsControl">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border BorderBrush="{DynamicResource MaterialDesignDivider}" 
                                                                BorderThickness="1" 
                                                                CornerRadius="4"
                                                                Padding="8"
                                                                Margin="0,0,0,8">
                                                            <StackPanel>
                                                                <Grid>
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="*"/>
                                                                        <ColumnDefinition Width="Auto"/>
                                                                    </Grid.ColumnDefinitions>
                                                                    <TextBox Text="{Binding Label, UpdateSourceTrigger=PropertyChanged}"
                                                                             materialDesign:HintAssist.Hint="Branch Label"
                                                                             TextChanged="BranchLabel_Changed"/>
                                                                    <Button Grid.Column="1"
                                                                            Style="{StaticResource MaterialDesignIconButton}"
                                                                            Width="24" Height="24"
                                                                            ToolTip="Remove Branch"
                                                                            Click="RemoveBranch_Click"
                                                                            Tag="{Binding}">
                                                                        <materialDesign:PackIcon Kind="Close" Width="16" Height="16"/>
                                                                    </Button>
                                                                </Grid>
                                                                <ComboBox materialDesign:HintAssist.Hint="Condition Type"
                                                                          SelectionChanged="BranchConditionType_Changed"
                                                                          Tag="{Binding}"
                                                                          Margin="0,4,0,0"
                                                                          Loaded="BranchConditionTypeCombo_Loaded">
                                                                    <ComboBoxItem Content="Output Contains" Tag="OutputContains"/>
                                                                    <ComboBoxItem Content="Output Matches" Tag="OutputMatches"/>
                                                                    <ComboBoxItem Content="Regex Match" Tag="Regex"/>
                                                                    <ComboBoxItem Content="Success" Tag="Success"/>
                                                                </ComboBox>
                                                                <TextBox Text="{Binding Condition.ComparisonValue, UpdateSourceTrigger=PropertyChanged}"
                                                                         materialDesign:HintAssist.Hint="Comparison Value"
                                                                         TextChanged="BranchConditionValue_Changed"
                                                                         Margin="0,4,0,0"/>
                                                                <TextBlock Text="{Binding NextStepId, StringFormat='→ Target: {0}'}"
                                                                           FontSize="10"
                                                                           Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                                           Margin="0,4,0,0"/>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                            
                                            <Button Content="Add Branch"
                                                    Click="AddBranch_Click"
                                                    Style="{StaticResource MaterialDesignOutlinedButton}"
                                                    Height="28"
                                                    FontSize="11"
                                                    Margin="0,4,0,0"/>
                                            
                                            <TextBlock Text="Default Next Step (when no branch matches):"
                                                       FontSize="11"
                                                       Foreground="{DynamicResource MaterialDesignBody}"
                                                       Margin="0,12,0,4"/>
                                            <ComboBox x:Name="DefaultNextStepCombo"
                                                      materialDesign:HintAssist.Hint="Default Next Step"
                                                      DisplayMemberPath="Name"
                                                      SelectedValuePath="StepId"
                                                      Foreground="{DynamicResource MaterialDesignBody}"
                                                      SelectionChanged="DefaultNextStep_Changed"/>
                                        </StackPanel>
                                        
                                        <!-- Parallel Configuration -->
                                        <StackPanel x:Name="ParallelConfigPanel" Visibility="Collapsed" Margin="0,12,0,0">
                                            <TextBlock Text="PARALLEL CONFIGURATION" 
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                       Margin="0,0,0,8"/>
                                            
                                            <TextBlock Text="Select steps to execute in parallel:"
                                                       FontSize="11"
                                                       Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                       Margin="0,0,0,8"/>
                                            
                                            <ListBox x:Name="ParallelBranchStepsList"
                                                     SelectionMode="Multiple"
                                                     MaxHeight="150"
                                                     DisplayMemberPath="Name"
                                                     SelectionChanged="ParallelBranchSteps_Changed"/>
                                            
                                            <TextBox x:Name="ParallelOutputPrefixBox"
                                                     materialDesign:HintAssist.Hint="Output Variable Prefix"
                                                     Text="parallel_branch"
                                                     Foreground="{DynamicResource MaterialDesignBody}"
                                                     TextChanged="ParallelConfig_Changed"
                                                     Margin="0,8,0,0"/>
                                            
                                            <CheckBox x:Name="ParallelWaitForAllCheck"
                                                      Content="Wait for all branches"
                                                      IsChecked="True"
                                                      Checked="ParallelConfig_Changed"
                                                      Unchecked="ParallelConfig_Changed"
                                                      Foreground="{DynamicResource MaterialDesignBody}"
                                                      Margin="0,8,0,0"/>
                                            
                                            <CheckBox x:Name="ParallelContinueOnFailureCheck"
                                                      Content="Continue if any branch fails"
                                                      Checked="ParallelConfig_Changed"
                                                      Unchecked="ParallelConfig_Changed"
                                                      Foreground="{DynamicResource MaterialDesignBody}"
                                                      Margin="0,4,0,0"/>
                                        </StackPanel>
                                        
                                        <!-- Loop Configuration -->
                                        <StackPanel x:Name="LoopConfigPanel" Visibility="Collapsed" Margin="0,12,0,0">
                                            <TextBlock Text="LOOP CONFIGURATION" 
                                                       FontWeight="SemiBold"
                                                       Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                       Margin="0,0,0,8"/>
                                            
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <TextBox x:Name="MaxIterationsBox"
                                                         materialDesign:HintAssist.Hint="Max Iterations"
                                                         Text="10"
                                                         Foreground="{DynamicResource MaterialDesignBody}"
                                                         TextChanged="LoopConfig_Changed"
                                                         Margin="0,0,4,0"/>
                                                
                                                <TextBox x:Name="LoopVariableBox"
                                                         Grid.Column="1"
                                                         materialDesign:HintAssist.Hint="Loop Variable"
                                                         Text="iteration_count"
                                                         Foreground="{DynamicResource MaterialDesignBody}"
                                                         TextChanged="LoopConfig_Changed"
                                                         Margin="4,0,0,0"/>
                                            </Grid>
                                            
                                            <TextBlock Text="Exit Condition" 
                                                       Foreground="{DynamicResource MaterialDesignBody}"
                                                       Margin="0,8,0,4"/>
                                            <TextBlock Text="Loop exits when condition is met, or after max iterations."
                                                       FontSize="10"
                                                       Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                       TextWrapping="Wrap"
                                                       Margin="0,0,0,4"/>
                                            <ComboBox x:Name="ExitConditionTypeCombo"
                                                      materialDesign:HintAssist.Hint="Condition Type"
                                                      Foreground="{DynamicResource MaterialDesignBody}"
                                                      SelectionChanged="LoopConfig_Changed"
                                                      Margin="0,0,0,4">
                                                <ComboBoxItem Content="Output Contains" Tag="OutputContains" ToolTip="Exit when output contains the specified text"/>
                                                <ComboBoxItem Content="Output Matches" Tag="OutputMatches" ToolTip="Exit when output exactly matches the specified text"/>
                                                <ComboBoxItem Content="Regex Match" Tag="Regex" ToolTip="Exit when output matches the regex pattern"/>
                                                <ComboBoxItem Content="Success (First Success)" Tag="Success" ToolTip="Exit on first successful iteration"/>
                                                <ComboBoxItem Content="Output Length" Tag="OutputLength" ToolTip="Exit when output length meets the threshold"/>
                                                <ComboBoxItem Content="Token Count" Tag="TokenCount" ToolTip="Exit when estimated token count meets the threshold"/>
                                            </ComboBox>
                                            <TextBox x:Name="ExitConditionValueBox"
                                                     materialDesign:HintAssist.Hint="Condition Value (e.g., 'DONE' or regex pattern)"
                                                     Foreground="{DynamicResource MaterialDesignBody}"
                                                     TextChanged="LoopConfig_Changed"/>
                                            <TextBlock x:Name="ExitConditionHint"
                                                       FontSize="10"
                                                       Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                       TextWrapping="Wrap"
                                                       Margin="0,4,0,0"/>
                                            <TextBlock x:Name="RegexValidationMessage"
                                                       Foreground="Red"
                                                       FontSize="11"
                                                       TextWrapping="Wrap"
                                                       Visibility="Collapsed"
                                                       Margin="0,4,0,0"/>
                                        </StackPanel>
                                        
                                        <!-- Error Handling -->
                                        <Expander Header="Error Handling" 
                                                  Foreground="{DynamicResource MaterialDesignBody}"
                                                  Margin="0,12,0,0">
                                            <StackPanel Margin="0,8,0,0">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    
                                                    <TextBox x:Name="MaxRetriesBox"
                                                             materialDesign:HintAssist.Hint="Max Retries"
                                                             Text="0"
                                                             TextChanged="ErrorHandling_Changed"
                                                             Margin="0,0,4,0"/>
                                                    
                                                    <TextBox x:Name="RetryDelayBox"
                                                             Grid.Column="1"
                                                             materialDesign:HintAssist.Hint="Retry Delay (ms)"
                                                             Text="1000"
                                                             TextChanged="ErrorHandling_Changed"
                                                             Margin="4,0,0,0"/>
                                                </Grid>
                                                
                                                <CheckBox x:Name="ExponentialBackoffCheck"
                                                          Content="Exponential Backoff"
                                                          IsChecked="True"
                                                          Checked="ErrorHandling_Changed"
                                                          Unchecked="ErrorHandling_Changed"
                                                          Foreground="{DynamicResource MaterialDesignBody}"
                                                          Margin="0,8,0,0"/>
                                                
                                                <CheckBox x:Name="ContinueOnErrorCheck"
                                                          Content="Continue on Error"
                                                          Checked="ErrorHandling_Changed"
                                                          Unchecked="ErrorHandling_Changed"
                                                          Foreground="{DynamicResource MaterialDesignBody}"
                                                          Margin="0,4,0,0"/>
                                                
                                                <TextBlock Text="Fallback Step (on failure):"
                                                           FontSize="11"
                                                           Foreground="{DynamicResource MaterialDesignBody}"
                                                           Margin="0,12,0,4"/>
                                                <ComboBox x:Name="FallbackStepCombo"
                                                          materialDesign:HintAssist.Hint="Fallback Step"
                                                          DisplayMemberPath="Name"
                                                          SelectedValuePath="StepId"
                                                          Foreground="{DynamicResource MaterialDesignBody}"
                                                          SelectionChanged="FallbackStep_Changed"/>
                                            </StackPanel>
                                        </Expander>
                                        
                                        <!-- Step Flags -->
                                        <StackPanel Orientation="Horizontal" Margin="0,12,0,0">
                                            <CheckBox x:Name="IsStartStepCheck"
                                                      Content="Start Step"
                                                      Checked="StepFlag_Changed"
                                                      Unchecked="StepFlag_Changed"
                                                      Foreground="{DynamicResource MaterialDesignBody}"
                                                      Margin="0,0,16,0"/>
                                            <CheckBox x:Name="IsEndStepCheck"
                                                      Content="End Step"
                                                      Checked="StepFlag_Changed"
                                                      Unchecked="StepFlag_Changed"
                                                      Foreground="{DynamicResource MaterialDesignBody}"/>
                                        </StackPanel>
                                    </StackPanel>
                                </StackPanel>
                            </ScrollViewer>
                        </Border>
                    </Grid>
                </TabItem>
                
                <!-- List View Tab (Simple Linear Editor) -->
                <TabItem>
                    <TabItem.Header>
                        <StackPanel Orientation="Horizontal" ToolTip="Simple linear workflow editor. Use Visual Designer for advanced features like branches, loops, and parallel steps.">
                            <materialDesign:PackIcon Kind="FormatListBulleted" VerticalAlignment="Center"/>
                            <TextBlock Text="List View (Linear)" Margin="8,0,0,0"/>
                        </StackPanel>
                    </TabItem.Header>
                    
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Info Banner -->
                        <Border Grid.Row="0" Background="{DynamicResource MaterialDesignToolBarBackground}" 
                                CornerRadius="4" Padding="12,8" Margin="0,0,0,8">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="InformationOutline" VerticalAlignment="Center" 
                                                         Foreground="{DynamicResource PrimaryHueMidBrush}"/>
                                <TextBlock Text="This view is for simple linear workflows. For conditional branches, loops, parallel execution, and advanced connections, use the Visual Designer tab."
                                           TextWrapping="Wrap" Margin="8,0,0,0" FontSize="11"
                                           Foreground="{DynamicResource MaterialDesignBodyLight}"/>
                            </StackPanel>
                        </Border>
                        
                        <!-- Steps Header -->
                        <Grid Grid.Row="1" Margin="0,8,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="WORKFLOW STEPS" 
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource MaterialDesignBodyLight}"
                                       VerticalAlignment="Center"/>
                            <Button Grid.Column="1"
                                    Content="Add Step"
                                    Click="AddStep_Click"
                                    Style="{StaticResource MaterialDesignRaisedButton}"
                                    Height="28"
                                    FontSize="12"
                                    ToolTip="Add a new standard step to the workflow"/>
                        </Grid>
                        
                        <!-- Steps List -->
                        <Border Grid.Row="2" 
                                BorderBrush="{DynamicResource MaterialDesignDivider}" 
                                BorderThickness="1" 
                                CornerRadius="4">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <ItemsControl x:Name="StepsList" Margin="8">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="{DynamicResource MaterialDesignCardBackground}" 
                                                    CornerRadius="4" 
                                                    Margin="0,4" 
                                                    Padding="12">
                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                    </Grid.RowDefinitions>
                                                    
                                                    <!-- Step Header -->
                                                    <Grid Grid.Row="0">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>
                                                        
                                                        <Border Grid.Column="0" 
                                                                Background="{DynamicResource PrimaryHueMidBrush}" 
                                                                CornerRadius="12" 
                                                                Width="24" Height="24"
                                                                Margin="0,0,8,0">
                                                            <TextBlock Text="{Binding Order}" 
                                                                       Foreground="White" 
                                                                       HorizontalAlignment="Center" 
                                                                       VerticalAlignment="Center"
                                                                       FontSize="12"/>
                                                        </Border>
                                                        
                                                        <!-- Step Type and Flags Indicator -->
                                                        <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="0,0,8,0" VerticalAlignment="Center">
                                                            <TextBlock Text="{Binding StepType}" FontSize="9" Padding="4,2"
                                                                       Foreground="{DynamicResource MaterialDesignBodyLight}"
                                                                       Background="{DynamicResource MaterialDesignToolBarBackground}"
                                                                       ToolTip="Step type. Use Visual Designer to change."/>
                                                            <materialDesign:PackIcon Kind="Play" Width="14" Height="14" Margin="4,0,0,0"
                                                                                     Foreground="Green" VerticalAlignment="Center"
                                                                                     Visibility="{Binding IsStartStep, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                                                     ToolTip="Start Step"/>
                                                            <materialDesign:PackIcon Kind="Stop" Width="14" Height="14" Margin="4,0,0,0"
                                                                                     Foreground="Red" VerticalAlignment="Center"
                                                                                     Visibility="{Binding IsEndStep, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                                                     ToolTip="End Step"/>
                                                        </StackPanel>
                                                        
                                                        <TextBox Grid.Column="2"
                                                                 Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"
                                                                 materialDesign:HintAssist.Hint="Step Name"
                                                                 Margin="0,0,8,0"
                                                                 Foreground="{DynamicResource MaterialDesignBody}"/>
                                                        
                                                        <Button Grid.Column="3"
                                                                Content="{materialDesign:PackIcon Kind=ArrowUp}"
                                                                Click="MoveStepUp_Click"
                                                                Tag="{Binding}"
                                                                Style="{StaticResource MaterialDesignIconButton}"
                                                                Width="28" Height="28"
                                                                ToolTip="Move Up (reorders linear flow)"/>
                                                        <Button Grid.Column="4"
                                                                Content="{materialDesign:PackIcon Kind=ArrowDown}"
                                                                Click="MoveStepDown_Click"
                                                                Tag="{Binding}"
                                                                Style="{StaticResource MaterialDesignIconButton}"
                                                                Width="28" Height="28"
                                                                ToolTip="Move Down (reorders linear flow)"/>
                                                        <Button Grid.Column="5"
                                                                Content="{materialDesign:PackIcon Kind=Delete}"
                                                                Click="DeleteStep_Click"
                                                                Tag="{Binding}"
                                                                Style="{StaticResource MaterialDesignIconButton}"
                                                                Foreground="#D32F2F"
                                                                Width="28" Height="28"
                                                                ToolTip="Delete Step (cleans up all references)"/>
                                                    </Grid>
                                                    
                                                    <!-- Step Description -->
                                                    <TextBox Grid.Row="1"
                                                             Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}"
                                                             materialDesign:HintAssist.Hint="Step Description (optional)"
                                                             Margin="32,8,0,0"
                                                             Foreground="{DynamicResource MaterialDesignBody}"/>
                                                    
                                                    <!-- Prompt Template -->
                                                    <Border Grid.Row="2" 
                                                            BorderBrush="{DynamicResource MaterialDesignDivider}" 
                                                            BorderThickness="1" 
                                                            CornerRadius="4"
                                                            Margin="32,8,0,0">
                                                        <TextBox Text="{Binding PromptTemplate, UpdateSourceTrigger=PropertyChanged}"
                                                                 AcceptsReturn="True"
                                                                 TextWrapping="Wrap"
                                                                 MinHeight="80"
                                                                 MaxHeight="150"
                                                                 VerticalScrollBarVisibility="Auto"
                                                                 Padding="8"
                                                                 FontFamily="Consolas"
                                                                 FontSize="12"
                                                                 BorderThickness="0"
                                                                 materialDesign:HintAssist.Hint="Prompt template. Use {{input}}, {{previous_output}}, {{step1}}, etc."
                                                                 Foreground="{DynamicResource MaterialDesignBody}"
                                                                 Background="Transparent"/>
                                                    </Border>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </Border>
                    </Grid>
                </TabItem>
            </TabControl>
            
            <!-- Footer Buttons -->
            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,16,0,0">
                <Button Content="Validate"
                        Click="Validate_Click"
                        Style="{StaticResource MaterialDesignFlatMidBgButton}"
                        Margin="0,0,8,0">
                    <Button.ToolTip>
                        <ToolTip MaxWidth="350">
                            <TextBlock TextWrapping="Wrap">
                                Validates workflow structure:
                                • Exactly one start step required
                                • All steps must be reachable from start
                                • Step references must exist (NextStepId, branches, fallbacks)
                                • Loop steps need valid exit conditions (MaxIterations ≥ 1)
                                • Conditional steps need branches or default next step
                                • Parallel steps need at least one branch step
                                • No self-references or circular dependencies
                            </TextBlock>
                        </ToolTip>
                    </Button.ToolTip>
                </Button>
                <Button Content="Cancel"
                        Click="Cancel_Click"
                        Style="{StaticResource MaterialDesignFlatMidBgButton}"
                        Margin="0,0,8,0"/>
                <Button x:Name="SaveButton"
                        Content="Save Workflow"
                        Click="Save_Click"
                        Style="{StaticResource MaterialDesignRaisedButton}">
                    <Button.ToolTip>
                        <ToolTip>Validates and saves the workflow. Errors must be fixed before saving.</ToolTip>
                    </Button.ToolTip>
                </Button>
            </StackPanel>
        </Grid>
    </materialDesign:DialogHost>
</Window>
