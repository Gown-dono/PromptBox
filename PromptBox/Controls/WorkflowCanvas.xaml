<UserControl x:Class="PromptBox.Controls.WorkflowCanvas"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             Background="{DynamicResource MaterialDesignPaper}">
    <Grid>
        <!-- Toolbar -->
        <ToolBarTray DockPanel.Dock="Top" VerticalAlignment="Top" Panel.ZIndex="100">
            <ToolBar Style="{StaticResource MaterialDesignToolBar}">
                <Button x:Name="AddStepButton" 
                        ToolTip="Add Standard Step"
                        Click="AddStep_Click">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Plus" />
                        <TextBlock Text="Add Step" Margin="4,0,0,0"/>
                    </StackPanel>
                </Button>
                
                <Button x:Name="AddConditionalButton" 
                        ToolTip="Add Conditional Branch"
                        Click="AddConditional_Click">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="CallSplit" />
                        <TextBlock Text="Conditional" Margin="4,0,0,0"/>
                    </StackPanel>
                </Button>
                
                <Button x:Name="AddLoopButton" 
                        ToolTip="Add Loop"
                        Click="AddLoop_Click">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Repeat" />
                        <TextBlock Text="Loop" Margin="4,0,0,0"/>
                    </StackPanel>
                </Button>
                
                <Separator />
                
                <Button x:Name="ConnectButton" 
                        ToolTip="Connect Nodes (Ctrl+Click)"
                        Click="Connect_Click">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="VectorLine" />
                        <TextBlock Text="Connect" Margin="4,0,0,0"/>
                    </StackPanel>
                </Button>
                
                <Button x:Name="DeleteButton" 
                        ToolTip="Delete Selected (Del)"
                        Click="Delete_Click">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Delete" />
                        <TextBlock Text="Delete" Margin="4,0,0,0"/>
                    </StackPanel>
                </Button>
                
                <Separator />
                
                <Button x:Name="AutoLayoutButton" 
                        ToolTip="Auto Layout"
                        Click="AutoLayout_Click">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="AutoFix" />
                        <TextBlock Text="Auto Layout" Margin="4,0,0,0"/>
                    </StackPanel>
                </Button>
                
                <Separator />
                
                <TextBlock Text="Zoom:" VerticalAlignment="Center" Margin="8,0,4,0"/>
                <Slider x:Name="ZoomSlider" 
                        Width="100" 
                        Minimum="50" 
                        Maximum="200" 
                        Value="100"
                        TickFrequency="25"
                        IsSnapToTickEnabled="True"
                        ValueChanged="ZoomSlider_ValueChanged"/>
                <TextBlock x:Name="ZoomText" Text="100%" VerticalAlignment="Center" Margin="4,0,0,0"/>
                
                <Separator />
                
                <CheckBox x:Name="SnapToGridCheckBox" 
                          Content="Snap to Grid"
                          IsChecked="True"/>
                
                <Separator />
                
                <Button x:Name="DuplicateButton" 
                        ToolTip="Duplicate Selected (Ctrl+D)"
                        Click="Duplicate_Click">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="ContentCopy" />
                        <TextBlock Text="Duplicate" Margin="4,0,0,0"/>
                    </StackPanel>
                </Button>
                
                <Separator />
                
                <Button x:Name="ExportPngButton" 
                        ToolTip="Export as PNG"
                        Click="ExportPng_Click">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Image" />
                        <TextBlock Text="PNG" Margin="4,0,0,0"/>
                    </StackPanel>
                </Button>
                
                <Button x:Name="ExportJsonButton" 
                        ToolTip="Export as JSON"
                        Click="ExportJson_Click">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="CodeJson" />
                        <TextBlock Text="JSON" Margin="4,0,0,0"/>
                    </StackPanel>
                </Button>
            </ToolBar>
        </ToolBarTray>
        
        <!-- Canvas Container with Scroll -->
        <ScrollViewer x:Name="CanvasScrollViewer"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      Margin="0,40,0,0"
                      PreviewMouseWheel="CanvasScrollViewer_PreviewMouseWheel"
                      PreviewMouseDown="CanvasScrollViewer_PreviewMouseDown"
                      PreviewMouseMove="CanvasScrollViewer_PreviewMouseMove"
                      PreviewMouseUp="CanvasScrollViewer_PreviewMouseUp">
            
            <Grid x:Name="CanvasContainer">
                <Grid.LayoutTransform>
                    <ScaleTransform x:Name="CanvasScale" ScaleX="1" ScaleY="1"/>
                </Grid.LayoutTransform>
                
                <!-- Grid Background -->
                <Canvas x:Name="GridCanvas" 
                        Width="2000" Height="1500">
                    <Canvas.Background>
                        <DrawingBrush TileMode="Tile" 
                                      Viewport="0,0,16,16" 
                                      ViewportUnits="Absolute">
                            <DrawingBrush.Drawing>
                                <GeometryDrawing>
                                    <GeometryDrawing.Geometry>
                                        <EllipseGeometry Center="8,8" RadiusX="1" RadiusY="1"/>
                                    </GeometryDrawing.Geometry>
                                    <GeometryDrawing.Brush>
                                        <SolidColorBrush Color="#20000000"/>
                                    </GeometryDrawing.Brush>
                                </GeometryDrawing>
                            </DrawingBrush.Drawing>
                        </DrawingBrush>
                    </Canvas.Background>
                </Canvas>
                
                <!-- Connectors Layer -->
                <Canvas x:Name="ConnectorsCanvas" 
                        Width="2000" Height="1500"
                        Background="Transparent"/>
                
                <!-- Nodes Layer -->
                <Canvas x:Name="NodesCanvas" 
                        Width="2000" Height="1500"
                        Background="Transparent"
                        MouseLeftButtonDown="NodesCanvas_MouseLeftButtonDown"/>
                
                <!-- Flow Indicators Layer (above nodes so dots are visible) -->
                <Canvas x:Name="FlowIndicatorsCanvas" 
                        Width="2000" Height="1500"
                        Background="Transparent"
                        IsHitTestVisible="False"/>
                
                <!-- Connection Drawing Preview -->
                <Canvas x:Name="PreviewCanvas" 
                        Width="2000" Height="1500"
                        Background="Transparent"
                        IsHitTestVisible="False"/>
                
                <!-- Enhancement 3: Alignment Guides Layer -->
                <Canvas x:Name="AlignmentGuidesCanvas" 
                        Width="2000" Height="1500"
                        Background="Transparent"
                        IsHitTestVisible="False"/>
            </Grid>
        </ScrollViewer>
        
        <!-- Connection Mode Indicator -->
        <Border x:Name="ConnectionModeIndicator"
                Background="{DynamicResource SecondaryHueMidBrush}"
                CornerRadius="4"
                Padding="12,6"
                HorizontalAlignment="Center"
                VerticalAlignment="Bottom"
                Margin="0,0,0,20"
                Visibility="Collapsed">
            <TextBlock Text="Click a target node to connect, or press Escape to cancel"
                       Foreground="White"
                       FontWeight="SemiBold"/>
        </Border>
        
        <!-- Minimap -->
        <Border x:Name="Minimap"
                Width="180" Height="120"
                Background="{DynamicResource MaterialDesignCardBackground}"
                BorderBrush="{DynamicResource MaterialDesignDivider}"
                BorderThickness="1"
                CornerRadius="4"
                HorizontalAlignment="Right"
                VerticalAlignment="Bottom"
                Margin="0,0,10,10"
                Visibility="Visible"
                MouseLeftButtonDown="Minimap_MouseLeftButtonDown">
            <Grid>
                <Canvas x:Name="MinimapCanvas" ClipToBounds="True"/>
                <!-- Viewport indicator -->
                <Border x:Name="MinimapViewport"
                        BorderBrush="{DynamicResource PrimaryHueMidBrush}"
                        BorderThickness="2"
                        Background="#20000000"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        IsHitTestVisible="False"/>
                <!-- Minimap label -->
                <TextBlock Text="Minimap"
                           FontSize="9"
                           Foreground="{DynamicResource MaterialDesignBodyLight}"
                           HorizontalAlignment="Left"
                           VerticalAlignment="Top"
                           Margin="4,2"/>
            </Grid>
        </Border>
        
        <!-- Undo/Redo indicator -->
        <Border x:Name="UndoRedoIndicator"
                Background="{DynamicResource MaterialDesignCardBackground}"
                BorderBrush="{DynamicResource MaterialDesignDivider}"
                BorderThickness="1"
                CornerRadius="4"
                Padding="8,4"
                HorizontalAlignment="Left"
                VerticalAlignment="Bottom"
                Margin="10,0,0,10">
            <StackPanel Orientation="Horizontal">
                <Button x:Name="UndoButton"
                        ToolTip="Undo (Ctrl+Z)"
                        Click="Undo_Click"
                        Style="{StaticResource MaterialDesignIconButton}"
                        Width="28" Height="28"
                        IsEnabled="False">
                    <materialDesign:PackIcon Kind="Undo" Width="16" Height="16"/>
                </Button>
                <Button x:Name="RedoButton"
                        ToolTip="Redo (Ctrl+Y)"
                        Click="Redo_Click"
                        Style="{StaticResource MaterialDesignIconButton}"
                        Width="28" Height="28"
                        IsEnabled="False">
                    <materialDesign:PackIcon Kind="Redo" Width="16" Height="16"/>
                </Button>
                <TextBlock x:Name="UndoRedoText"
                           Text=""
                           FontSize="10"
                           Foreground="{DynamicResource MaterialDesignBodyLight}"
                           VerticalAlignment="Center"
                           Margin="4,0,0,0"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>
