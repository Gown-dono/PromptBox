<UserControl x:Class="PromptBox.Controls.WorkflowNode"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             Width="200" MinHeight="100">
    <UserControl.Resources>
        <Style x:Key="ConnectorStyle" TargetType="Ellipse">
            <Setter Property="Width" Value="12"/>
            <Setter Property="Height" Value="12"/>
            <Setter Property="Fill" Value="{DynamicResource MaterialDesignBody}"/>
            <Setter Property="Stroke" Value="{DynamicResource PrimaryHueMidBrush}"/>
            <Setter Property="StrokeThickness" Value="2"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Fill" Value="{DynamicResource PrimaryHueMidBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>
    
    <Grid>
        <!-- Input Connector (Top) -->
        <Ellipse x:Name="InputConnector" 
                 Style="{StaticResource ConnectorStyle}"
                 HorizontalAlignment="Center" 
                 VerticalAlignment="Top"
                 Margin="0,-6,0,0"
                 MouseLeftButtonDown="InputConnector_MouseLeftButtonDown"/>
        
        <!-- Main Card -->
        <materialDesign:Card x:Name="NodeCard" 
                             Margin="0,6,0,6"
                             Padding="0"
                             UniformCornerRadius="8"
                             Background="{DynamicResource MaterialDesignCardBackground}"
                             MouseLeftButtonDown="NodeCard_MouseLeftButtonDown"
                             MouseMove="NodeCard_MouseMove"
                             MouseLeftButtonUp="NodeCard_MouseLeftButtonUp">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Header -->
                <Border x:Name="HeaderBorder" 
                        Grid.Row="0" 
                        Background="{DynamicResource PrimaryHueMidBrush}"
                        CornerRadius="8,8,0,0"
                        Padding="8,6">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <!-- Step Number Badge -->
                        <Border Grid.Column="0" 
                                Background="{DynamicResource PrimaryHueDarkBrush}"
                                CornerRadius="10"
                                Padding="6,2"
                                Margin="0,0,8,0">
                            <TextBlock x:Name="StepNumberText"
                                       Text="1"
                                       FontSize="11"
                                       FontWeight="Bold"
                                       Foreground="White"/>
                        </Border>
                        
                        <!-- Step Name -->
                        <TextBlock x:Name="StepNameText"
                                   Grid.Column="1"
                                   Text="Step Name"
                                   FontWeight="SemiBold"
                                   Foreground="White"
                                   TextTrimming="CharacterEllipsis"
                                   VerticalAlignment="Center"/>
                        
                        <!-- Step Type Icon -->
                        <materialDesign:PackIcon x:Name="StepTypeIcon"
                                                 Grid.Column="2"
                                                 Kind="Play"
                                                 Width="16" Height="16"
                                                 Foreground="White"
                                                 VerticalAlignment="Center"/>
                    </Grid>
                </Border>
                
                <!-- Body - Prompt Preview -->
                <Border Grid.Row="1" Padding="8">
                    <TextBlock x:Name="PromptPreviewText"
                               Text="Prompt preview..."
                               FontSize="11"
                               Foreground="{DynamicResource MaterialDesignBodyLight}"
                               TextWrapping="Wrap"
                               TextTrimming="CharacterEllipsis"
                               MaxHeight="60"/>
                </Border>
                
                <!-- Footer - Status -->
                <Border Grid.Row="2" 
                        Background="{DynamicResource MaterialDesignToolBarBackground}"
                        CornerRadius="0,0,8,8"
                        Padding="8,4">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock x:Name="StatusText"
                                   Text="Ready"
                                   FontSize="10"
                                   Foreground="{DynamicResource MaterialDesignBodyLight}"
                                   VerticalAlignment="Center"/>
                        
                        <materialDesign:PackIcon x:Name="StatusIcon"
                                                 Grid.Column="1"
                                                 Kind="CheckCircle"
                                                 Width="14" Height="14"
                                                 Foreground="{DynamicResource MaterialDesignBodyLight}"/>
                    </Grid>
                </Border>
            </Grid>
        </materialDesign:Card>
        
        <!-- Output Connector (Bottom) -->
        <Ellipse x:Name="OutputConnector" 
                 Style="{StaticResource ConnectorStyle}"
                 HorizontalAlignment="Center" 
                 VerticalAlignment="Bottom"
                 Margin="0,0,0,-6"
                 MouseLeftButtonDown="OutputConnector_MouseLeftButtonDown"/>
        
        <!-- Conditional Branch Connectors (Right side) -->
        <ItemsControl x:Name="BranchConnectors"
                      VerticalAlignment="Center"
                      HorizontalAlignment="Right"
                      Margin="0,20,0,20">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <StackPanel Orientation="Vertical" />
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
        </ItemsControl>
        
        <!-- Selection Border -->
        <Border x:Name="SelectionBorder"
                BorderBrush="{DynamicResource SecondaryHueMidBrush}"
                BorderThickness="3"
                CornerRadius="10"
                Margin="-2,4,-2,4"
                Visibility="Collapsed"/>
        
        <!-- Enhancement 1: Boundary Warning Border (shown when dragging beyond canvas bounds) -->
        <Border x:Name="BoundaryWarningBorder"
                BorderBrush="#F44336"
                BorderThickness="2"
                CornerRadius="10"
                Margin="-2,4,-2,4"
                Visibility="Collapsed">
            <Border.Effect>
                <DropShadowEffect Color="#F44336" BlurRadius="8" ShadowDepth="0" Opacity="0.5"/>
            </Border.Effect>
        </Border>
        
        <!-- Execution Indicator -->
        <ProgressBar x:Name="ExecutionProgress"
                     IsIndeterminate="True"
                     Style="{StaticResource MaterialDesignLinearProgressBar}"
                     VerticalAlignment="Top"
                     Margin="0,6,0,0"
                     Visibility="Collapsed"/>
    </Grid>
</UserControl>
